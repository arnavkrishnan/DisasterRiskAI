<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RiskRadar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="icon" type="image/x-icon" href="https://c.files.bbci.co.uk/CD98/production/_98123625_hi041060779.jpg">
</head>
<body>

  <nav class="blue darken-3">
    <div class="nav-wrapper container">
      <a href="#" class="brand-logo">RiskRadar</a>
    </div>
  </nav>

  <div class="container">
    <div class="row" style="margin-top: 20px;">
      <div class="input-field col s12 m9">
        <input id="countryInput" type="text" class="autocomplete" placeholder="Enter country (e.g., US, India, ALL)" />
      </div>
      <div class="col s12 m3">
        <button class="btn waves-effect waves-light blue" onclick="searchCountry()">Search</button>
      </div>
    </div>

    <div class="row">
      <div class="col s12 m8">
        <div id="map" class="z-depth-2" style="height: 500px;"></div>
      </div>

      <div class="col s12 m4">
        <ul class="tabs">
          <li class="tab col s6"><a class="active" href="#weatherTab">Weather</a></li>
          <li class="tab col s6"><a href="#aiTab">AI Risk Analysis</a></li>
        </ul>

        <div id="weatherTab" class="card white" style="padding: 15px;">
          <div id="weatherInfo">
            <p>Click on a city marker to view weather details.</p>
          </div>
        </div>

        <div id="aiTab" class="card white" style="padding: 15px;">
          <div id="aiAnalysis">
            <p>AI-generated risk analysis will appear here.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      var el = document.querySelectorAll('.tabs');
      M.Tabs.init(el, {});

      // Initialize autocomplete with some countries or cities for testing
      var countryInput = document.getElementById('countryInput');
      var autocompleteOptions = {
        data: {
          "US": null,
          "India": null,
          "Canada": null,
          "Australia": null,
          "Brazil": null,
          "Japan": null,
          "Mexico": null,
          "ALL": null
        },
        onAutocomplete: function(val) {
          // Optionally trigger a search when the user selects an option
          searchCountry();
        }
      };
      M.Autocomplete.init(countryInput, autocompleteOptions);
    });

    document.addEventListener('DOMContentLoaded', () => {
      var el = document.querySelectorAll('.tabs');
      M.Tabs.init(el, {});
    });

    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    async function searchCountry() {
      const country = document.getElementById('countryInput').value;
      console.log("Searching for country:", country);  // <-- ADD THIS

      if (!country) {
        alert('Please enter a country or ALL');
        return;
      }

      try {
        await fetch(`/scrape/${country}`);
        console.log("Scrape triggered for:", country);
      } catch (err) {
        console.error("Scrape error:", err);
      }

      const response = await fetch(`/cities/${country}`);
      if (!response.ok) {
        console.error("Failed to fetch cities:", response.statusText);
        alert('No cities found for this country.');
        return;
      }

      const cities = await response.json();
      console.log("Fetched cities:", cities); // ADD THIS LINE

      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      cities.forEach(city => {
        console.log("Adding marker for:", city.city); // ADD THIS
        const marker = L.marker([city.lat, city.lng]).addTo(map);
        marker.bindPopup(`<b>${city.city}</b><br>Click for weather info`);
        marker.on('click', () => {
          fetchWeather(city.city);
        });
        markers.push(marker);
      });

      if (cities.length > 0) {
        map.setView([cities[0].lat, cities[0].lng], 6);
      }
    }

    async function fetchWeather(city) {
      const response = await fetch(`/weather?city=${city}`);
      if (!response.ok) {
        document.getElementById('weatherInfo').innerHTML = `<p>No weather data found for ${city}.</p>`;
        return;
      }
      const weather = await response.json();
      const content = `
        <h5>${weather.city}</h5>
        <p><strong>Temperature:</strong> ${weather.temperature}°C</p>
        <p><strong>Feels Like:</strong> ${weather.feels_like}°C</p>
        <p><strong>Pressure:</strong> ${weather.pressure} hPa</p>
        <p><strong>Humidity:</strong> ${weather.humidity}%</p>
        <p><strong>Weather:</strong> ${weather.weather}</p>
        <p><strong>Wind Speed:</strong> ${weather.wind_speed} m/s</p>
        <p><strong>Wind Direction:</strong> ${weather.wind_deg}°</p>
        <p><strong>Visibility:</strong> ${weather.visibility} meters</p>
        <p><strong>Cloud Coverage:</strong> ${weather.clouds}%</p>
        <p><strong>Rainfall:</strong> ${weather.rainfall} mm</p>
        <p><strong>Snowfall:</strong> ${weather.snowfall} mm</p>
        <p><strong>Date:</strong> ${new Date(weather.date).toLocaleString()}</p>
      `;
      document.getElementById('weatherInfo').innerHTML = content;

      // For AI analysis
      const aiResponse = await fetch(`/analyze_weather?city=${city}`);
      const aiAnalysis = await aiResponse.json();
      const analysisContent = `
        <p><strong>AI Disaster Risk Analysis:</strong></p>
        <p>${aiAnalysis.analysis}</p>
      `;
      document.getElementById('aiAnalysis').innerHTML = analysisContent;
    }
  </script>
</body>
</html>
